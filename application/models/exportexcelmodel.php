<?phpclass exportExcelModel extends Model{		function __construct() {		parent::__construct();		include_once(ROOT."library/PHPExcel/Classes/PHPExcel.php");			}		function getAllData(){		$sql="		drop table if exists tmp_kpas;		CREATE TEMPORARY TABLE tmp_kpas		select a.assessment_id,au.role,au.user_id,a.diagnostic_id,c.client_name,c.client_id,ad.principal_name, n.network_name, st.school_type, ad.annual_fee, ad.no_of_students,ad.board_id,b.board, group_concat(rs.order order by kd.kpa_order) as kpa_score		from d_assessment a		inner join (select distinct r.assessment_id from h_assessment_report r) ar on ar.assessment_id=a.assessment_id		inner join d_client c on c.client_id=a.client_id		inner join h_assessment_user au on au.assessment_id=a.assessment_id 		inner join d_diagnostic d on d.diagnostic_id=a.diagnostic_id and d.assessment_type_id=1		inner join h_kpa_diagnostic kd on kd.diagnostic_id=a.diagnostic_id		inner join h_kpa_instance_score kps on kps.kpa_instance_id=kd.kpa_instance_id and kps.assessment_id=a.assessment_id and kps.assessor_id=au.user_id		inner join h_diagnostic_rating_scheme rs on rs.rating_id = kps.d_rating_rating_id and rs.diagnostic_id = a.diagnostic_id		left join d_AQS_data ad on ad.id=a.aqsdata_id        left join h_client_network cn on cn.client_id=a.client_id        left join d_network n on n.network_id=cn.network_id        left join d_school_type st on ad.school_type_id=st.school_type_id        left join d_board b on b.board_id=ad.board_id		where au.isFilled=1        group by a.assessment_id,au.role;				drop table if exists tmp_keyqs;				CREATE TEMPORARY TABLE tmp_keyqs		select tk.*,group_concat(rs.order order by kd.kpa_order,kk.kq_order) as kq_score		from tmp_kpas tk		inner join h_kpa_diagnostic kd on kd.diagnostic_id=tk.diagnostic_id		inner join h_kpa_kq kk on kd.kpa_instance_id=kk.kpa_instance_id		inner join h_kq_instance_score ks on ks.key_question_instance_id=kk.key_question_instance_id and ks.assessment_id=tk.assessment_id and ks.assessor_id=tk.user_id		inner join h_diagnostic_rating_scheme rs on rs.rating_id = ks.d_rating_rating_id and rs.diagnostic_id = tk.diagnostic_id        group by tk.assessment_id,tk.role;		drop table if exists tmp_kpas,tmp_coreqs;		CREATE TEMPORARY TABLE tmp_coreqs		select tk.*,group_concat(rs.order order by kd.kpa_order,kk.kq_order,kc.cq_order) as cq_score		from tmp_keyqs tk		inner join h_kpa_diagnostic kd on kd.diagnostic_id=tk.diagnostic_id		inner join h_kpa_kq kk on kd.kpa_instance_id=kk.kpa_instance_id		inner join h_kq_cq kc on kc.key_question_instance_id=kk.key_question_instance_id		inner join h_cq_score cs on cs.core_question_instance_id=kc.core_question_instance_id and cs.assessment_id=tk.assessment_id and cs.assessor_id=tk.user_id		inner join h_diagnostic_rating_scheme rs on rs.rating_id = cs.d_rating_rating_id and rs.diagnostic_id = tk.diagnostic_id        group by tk.assessment_id,tk.role;		drop table if exists tmp_keyqs;		";		if(!$this->db->query($sql))			return array();						$sql="select tc.*,group_concat(rs.order order by kd.kpa_order,kk.kq_order,kc.cq_order,cj.js_order) as js_score		from tmp_coreqs tc		inner join h_kpa_diagnostic kd on kd.diagnostic_id=tc.diagnostic_id		inner join h_kpa_kq kk on kd.kpa_instance_id=kk.kpa_instance_id		inner join h_kq_cq kc on kc.key_question_instance_id=kk.key_question_instance_id		inner join h_cq_js_instance cj on cj.core_question_instance_id=kc.core_question_instance_id		inner join f_score fs on fs.judgement_statement_instance_id=cj.judgement_statement_instance_id and tc.assessment_id=fs.assessment_id and fs.assessor_id=tc.user_id and fs.isFinal=1		inner join h_diagnostic_rating_scheme rs on rs.rating_id = fs.rating_id and rs.diagnostic_id = tc.diagnostic_id        group by tc.assessment_id,tc.role;";				$res= $this->db->get_results($sql);		if($res){			$assessments=array();			$assType=array(3=>'internal',4=>'external');			$kpaData=array(0=>array(),1=>array(),2=>array(),3=>array(),4=>array(),5=>array());			foreach($res as $row){				$scores=array(							"js_scores"=>empty($row['js_score'])?array():array_chunk(explode(",",$row['js_score']),3),							"cq_scores"=>empty($row['cq_score'])?array():array_chunk(explode(",",$row['cq_score']),3),							"kq_scores"=>empty($row['kq_score'])?array():array_chunk(explode(",",$row['kq_score']),3),							"kpa_scores"=>empty($row['kpa_score'])?array():explode(",",$row['kpa_score'])						);											if(isset($assessments[$row['assessment_id']])){					$assessments[$row['assessment_id']][$assType[$row['role']]]=$scores;				}else{					$assessments[$row['assessment_id']]=array("assessment_id"=>$row['assessment_id'],"user_id"=>$row['user_id'],"client_name"=>$row['client_name'],"client_id"=>$row['client_id'],"principal_name"=>$row['principal_name'], "network_name"=>$row['network_name'], "school_type"=>$row['school_type'], 'annual_fee'=>$row['annual_fee'], 'no_of_students'=>$row['no_of_students'],'board'=>$row['board'],"board_id"=>$row['board_id']);					$assessments[$row['assessment_id']][$assType[$row['role']]]=$scores;				}							}			return $assessments;		}else{			return array();		}	}/*public function getFileDetails($client_id,$assessment_type=1,$teacher_student=array(),$round="",$gaid=0){$evidence_condition=" (fs.evidence_text !=''  || f.file_id IS NOT NULL) ";$evidence_condition=" 1=1 ";if($assessment_type==2 || $assessment_type==4){ $onlyActive=" && dga.isGroupAssessmentActive=1"; $groupBy=" group by c.client_id,e.judgement_statement_text,hu.user_id,dga.student_round "; //$orderBy=" order by c.client_id,k.kpa_id,l.key_question_id,m.core_question_id,e.judgement_statement_id,hu.user_id,dga.student_round ";  $orderBy=" order by c.client_id,j.kpa_order ,i.kq_order,h.cq_order,d.js_order,hu.user_id,dga.student_round "; $onCondidtion=" a.assessment_id=b.assessment_id && a.judgement_statement_instance_id=b.judgement_statement_instance_id and a.judgement_statement_id = b.judgement_statement_id and a.client_id=b.client_id && a.student_round=b.student_round "; //$onCondidtion=" a.assessment_id=b.assessment_id "; //$final_order=" order by client_id,judgement_statement_id,name,student_round"; $final_order=" order by client_id,student_round,name,diagnostic_id,kpa_order,kq_order,cq_order,js_order "; if(count($teacher_student)>0){ $teacher_student_condiditon=" && a.user_id IN (".(implode(",",$teacher_student)).") "; }else{ $teacher_student_condiditon="";     }  if($round!=""){    $round_condiditon =" && dga.student_round='".$round."'"; }else{    $round_condiditon ="";  }  if($gaid>0){     $gaid_condition=" && dga.group_assessment_id='".$gaid."'"; }else{     $gaid_condition=""; } }else{ $onlyActive=" && a.isAssessmentActive=1"; $groupBy=" group by c.client_id,e.judgement_statement_text,a.aqs_round"; //$orderBy=" order by c.client_id,k.kpa_id,l.key_question_id,m.core_question_id,e.judgement_statement_id,a.aqs_round "; $orderBy=" order by c.client_id,j.kpa_order ,i.kq_order,h.cq_order,d.js_order,a.aqs_round "; $onCondidtion=" a.assessment_id=b.assessment_id && a.judgement_statement_instance_id=b.judgement_statement_instance_id and a.judgement_statement_id = b.judgement_statement_id and a.client_id=b.client_id && a.aqs_round=b.aqs_round "; //$final_order=" order by client_id,judgement_statement_id,aqs_round"; $final_order=" order by client_id,aqs_round,diagnostic_id,kpa_order,kq_order,cq_order,js_order"; $teacher_student_condiditon="";  if($round!=""){    $round_condiditon =" && a.aqs_round='".$round."'"; }else{    $round_condiditon ="";  }  if($gaid>0){     $gaid_condition=" && dga.group_assessment_id='".$gaid."'"; }else{     $gaid_condition=""; } }$assessmentCond = 'b.assessment_type_id=?';if(!empty($assessment_type) && $assessment_type == 'self'){    $assessment_type = 1;    $assessmentCond .= ' AND a.d_sub_assessment_type_id = 1';    $round_condiditon="";}$sql="select * from (select a.aqs_round,a.student_round,a.name,a.user_id,a.judgement_statement_id,a.judgement_statement_instance_id,a.client_id,a.client_name,a.js_order,a.cq_order,a.kq_order,a.kpa_order,a.kpa_id,a.kpa_name,a.key_question_text,a.core_question_text,a.judgement_statement_text,a.internal_evidence,b.external_evidence,ifnull(a.file_int,'') as file_int,ifnull(b.file_ext,'') as file_ext,a.network_name, a.province_name ,a.diagnostic_id from(select  a.aqs_round,dga.student_round,du.name,du.user_id,e.judgement_statement_id,fs.judgement_statement_instance_id,c.client_id,c.client_name,d.js_order,h.cq_order,i.kq_order,j.kpa_order,k.kpa_id,k.kpa_name,l.key_question_text,m.core_question_text,e.judgement_statement_text,fs.evidence_text as internal_evidence,group_concat(distinct g.file_name) as file_int, dn.network_name, dp.province_name,a.assessment_id,b.diagnostic_idfrom (select * from f_score where isFinal=1) fsinner join h_assessment_user hu on fs.assessment_id=hu.assessment_id and fs.assessor_id=hu.user_id and hu.role=3inner join d_assessment a on a.assessment_id=fs.assessment_idinner join d_diagnostic b on a.diagnostic_id=b.diagnostic_idinner join d_client c on a.client_id=c.client_idinner join h_cq_js_instance d on fs.judgement_statement_instance_id=d.judgement_statement_instance_idinner join (select djs.*,hlt.translation_text as judgement_statement_text from d_judgement_statement djs inner join h_lang_translation hlt on djs.equivalence_id=hlt.equivalence_id where language_id=9) e on d.judgement_statement_id= e.judgement_statement_idleft join h_score_file f on fs.score_id=f.score_idleft join d_file g on f.file_id=g.file_idleft join h_kq_cq h on d.core_question_instance_id=h.core_question_instance_idleft join h_kpa_kq i on h.key_question_instance_id=i.key_question_instance_idleft join h_kpa_diagnostic j on i.kpa_instance_id=j.kpa_instance_idleft join (select dkpa.*,hlt.translation_text as kpa_name from d_kpa dkpa inner join h_lang_translation hlt on dkpa.equivalence_id=hlt.equivalence_id where language_id=9) k on j.kpa_id=k.kpa_idleft join (select dkq.*,hlt.translation_text as key_question_text from d_key_question dkq inner join h_lang_translation hlt on dkq.equivalence_id=hlt.equivalence_id where language_id=9) l on i.key_question_id=l.key_question_idleft join (select dcq.*,hlt.translation_text as core_question_text from d_core_question dcq inner join h_lang_translation hlt on dcq.equivalence_id=hlt.equivalence_id where language_id=9) m on h.core_question_id=m.core_question_idleft join h_client_province hcp on hcp.client_id=c.client_idleft join d_province dp on dp.province_id=hcp.province_idleft join h_client_network hcn on c.client_id=hcn.client_idleft join d_network dn on dn.network_id=hcn.network_idleft join h_assessment_ass_group haag on haag.assessment_id=a.assessment_idleft join d_group_assessment dga on dga.group_assessment_id=haag.group_assessment_idleft join d_user du on du.user_id=hu.user_idwhere  $evidence_condition and $assessmentCond and c.client_id=? ".$onlyActive."  ".$round_condiditon." ".$gaid_condition."".$groupBy." ".$orderBy." ) aleft join (select  a.aqs_round,dga.student_round,du.name,du.user_id,e.judgement_statement_id,fs.judgement_statement_instance_id,c.client_id,c.client_name,d.js_order,h.cq_order,i.kq_order,j.kpa_order,k.kpa_id,k.kpa_name,l.key_question_text,m.core_question_text,e.judgement_statement_text,fs.evidence_text as external_evidence,group_concat(distinct g.file_name) as file_ext,a.assessment_idfrom (select * from f_score where isFinal=1) fsinner join h_assessment_user hu on fs.assessment_id=hu.assessment_id and fs.assessor_id=hu.user_id and hu.role=4inner join d_assessment a on a.assessment_id=fs.assessment_idinner join d_diagnostic b on a.diagnostic_id=b.diagnostic_idinner join d_client c on a.client_id=c.client_idinner join h_cq_js_instance d on fs.judgement_statement_instance_id=d.judgement_statement_instance_idinner join (select djs.*,hlt.translation_text as judgement_statement_text from d_judgement_statement djs  inner join h_lang_translation hlt on djs.equivalence_id=hlt.equivalence_id where language_id=9) e on d.judgement_statement_id= e.judgement_statement_idleft join h_score_file f on fs.score_id=f.score_idleft join d_file g on f.file_id=g.file_idleft join h_kq_cq h on d.core_question_instance_id=h.core_question_instance_idleft join h_kpa_kq i on h.key_question_instance_id=i.key_question_instance_idleft join h_kpa_diagnostic j on i.kpa_instance_id=j.kpa_instance_idleft join (select dkpa.*,hlt.translation_text as kpa_name from d_kpa dkpa inner join h_lang_translation hlt on dkpa.equivalence_id=hlt.equivalence_id where language_id=9) k on j.kpa_id=k.kpa_idleft join (select dkq.*,hlt.translation_text as key_question_text from d_key_question dkq inner join h_lang_translation hlt on dkq.equivalence_id=hlt.equivalence_id where language_id=9) l on i.key_question_id=l.key_question_idleft join (select dcq.*,hlt.translation_text as core_question_text from d_core_question dcq inner join h_lang_translation hlt on dcq.equivalence_id=hlt.equivalence_id where language_id=9) m on h.core_question_id=m.core_question_idleft join h_assessment_ass_group haag on haag.assessment_id=a.assessment_idleft join d_group_assessment dga on dga.group_assessment_id=haag.group_assessment_idleft join d_user du on du.user_id=hu.user_idwhere  $evidence_condition and $assessmentCond and c.client_id=?  ".$onlyActive." ".$round_condiditon."  ".$gaid_condition."".$groupBy." ".$orderBy.")bon ".$onCondidtion." where 1=1 ".$teacher_student_condiditon."UNIONselect b.aqs_round,b.student_round,b.name,b.user_id,b.judgement_statement_id,b.judgement_statement_instance_id,b.client_id,b.client_name,b.js_order,b.cq_order,b.kq_order,b.kpa_order,b.kpa_id,b.kpa_name,b.key_question_text,b.core_question_text,b.judgement_statement_text,a.internal_evidence,b.external_evidence,ifnull(a.file_int,'') as file_int,ifnull(b.file_ext,'') as file_ext,b.network_name, b.province_name, a.diagnostic_id  from(select  a.aqs_round,dga.student_round,du.name,du.user_id,e.judgement_statement_id,fs.judgement_statement_instance_id,c.client_id,c.client_name,d.js_order,h.cq_order,i.kq_order,j.kpa_order,k.kpa_id,k.kpa_name,l.key_question_text,m.core_question_text,e.judgement_statement_text,fs.evidence_text as internal_evidence,group_concat(distinct g.file_name) as file_int,a.assessment_id,b.diagnostic_idfrom (select * from f_score where isFinal=1) fsinner join h_assessment_user hu on fs.assessment_id=hu.assessment_id and fs.assessor_id=hu.user_id and hu.role=3inner join d_assessment a on a.assessment_id=fs.assessment_idinner join d_diagnostic b on a.diagnostic_id=b.diagnostic_idinner join d_client c on a.client_id=c.client_idinner join h_cq_js_instance d on fs.judgement_statement_instance_id=d.judgement_statement_instance_idinner join (select djs.*,hlt.translation_text as judgement_statement_text from d_judgement_statement djs inner join h_lang_translation hlt on djs.equivalence_id=hlt.equivalence_id where language_id=9) e on d.judgement_statement_id= e.judgement_statement_idleft join h_score_file f on fs.score_id=f.score_idleft join d_file g on f.file_id=g.file_idleft join h_kq_cq h on d.core_question_instance_id=h.core_question_instance_idleft join h_kpa_kq i on h.key_question_instance_id=i.key_question_instance_idleft join h_kpa_diagnostic j on i.kpa_instance_id=j.kpa_instance_idleft join (select dkpa.*,hlt.translation_text as kpa_name from d_kpa dkpa inner join h_lang_translation hlt on dkpa.equivalence_id=hlt.equivalence_id where language_id=9) k on j.kpa_id=k.kpa_idleft join (select dkq.*,hlt.translation_text as key_question_text from d_key_question dkq inner join h_lang_translation hlt on dkq.equivalence_id=hlt.equivalence_id where language_id=9) l on i.key_question_id=l.key_question_idleft join (select dcq.*,hlt.translation_text as core_question_text from d_core_question dcq inner join h_lang_translation hlt on dcq.equivalence_id=hlt.equivalence_id where language_id=9) m on h.core_question_id=m.core_question_idleft join h_assessment_ass_group haag on haag.assessment_id=a.assessment_idleft join d_group_assessment dga on dga.group_assessment_id=haag.group_assessment_idleft join d_user du on du.user_id=hu.user_idwhere $evidence_condition and $assessmentCond  and c.client_id=?  ".$onlyActive."  ".$round_condiditon."  ".$gaid_condition."".$groupBy." ".$orderBy." ) aright join (select  a.aqs_round,dga.student_round,du_internal.name,du_internal.user_id,e.judgement_statement_id,fs.judgement_statement_instance_id,c.client_id,c.client_name,d.js_order,h.cq_order,i.kq_order,j.kpa_order,k.kpa_id,k.kpa_name,l.key_question_text,m.core_question_text,e.judgement_statement_text,fs.evidence_text as external_evidence,group_concat(distinct g.file_name) as file_ext, dn.network_name, dp.province_name,a.assessment_idfrom (select * from f_score where isFinal=1) fsinner join h_assessment_user hu on fs.assessment_id=hu.assessment_id and fs.assessor_id=hu.user_id and hu.role=4inner join d_assessment a on a.assessment_id=fs.assessment_idinner join d_diagnostic b on a.diagnostic_id=b.diagnostic_idinner join d_client c on a.client_id=c.client_idinner join h_cq_js_instance d on fs.judgement_statement_instance_id=d.judgement_statement_instance_idinner join (select djs.*,hlt.translation_text as judgement_statement_text from d_judgement_statement djs inner join h_lang_translation hlt on djs.equivalence_id=hlt.equivalence_id where language_id=9) e on d.judgement_statement_id= e.judgement_statement_idleft join h_score_file f on fs.score_id=f.score_idleft join d_file g on f.file_id=g.file_idleft join h_kq_cq h on d.core_question_instance_id=h.core_question_instance_idleft join h_kpa_kq i on h.key_question_instance_id=i.key_question_instance_idleft join h_kpa_diagnostic j on i.kpa_instance_id=j.kpa_instance_idleft join (select dkpa.*,hlt.translation_text as kpa_name from d_kpa dkpa inner join h_lang_translation hlt on dkpa.equivalence_id=hlt.equivalence_id where language_id=9) k on j.kpa_id=k.kpa_idleft join (select dkq.*,hlt.translation_text as key_question_text from d_key_question dkq inner join h_lang_translation hlt on dkq.equivalence_id=hlt.equivalence_id where language_id=9) l on i.key_question_id=l.key_question_idleft join (select dcq.*,hlt.translation_text as core_question_text from d_core_question dcq inner join h_lang_translation hlt on dcq.equivalence_id=hlt.equivalence_id where language_id=9) m on h.core_question_id=m.core_question_idleft join h_client_province hcp on hcp.client_id=c.client_idleft join d_province dp on dp.province_id=hcp.province_idleft join h_client_network hcn on c.client_id=hcn.client_idleft join d_network dn on dn.network_id=hcn.network_idleft join h_assessment_ass_group haag on haag.assessment_id=a.assessment_idleft join d_group_assessment dga on dga.group_assessment_id=haag.group_assessment_idleft join d_user du on du.user_id=hu.user_idleft join h_assessment_user hu_internal on a.assessment_id=hu_internal.assessment_id and hu_internal.role=3left join d_user du_internal on du_internal.user_id=hu_internal.user_idwhere  $evidence_condition and $assessmentCond  and c.client_id=?  ".$onlyActive."   ".$round_condiditon."  ".$gaid_condition."".$groupBy." ".$orderBy.")bon ".$onCondidtion."  where 1=1  ".$teacher_student_condiditon.") final_table ".$final_order."";               //echo  $this->db->regenerateQuery($sql,array($assessment_type,$client_id,$assessment_type,$client_id,$assessment_type,$client_id,$assessment_type,$client_id));              //die("jjjj");                $res= $this->db->get_results($sql,array($assessment_type,$client_id,$assessment_type,$client_id,$assessment_type,$client_id,$assessment_type,$client_id));		if($res)                        {			return $res;		}else                {			return array();                	}     }*/        public function getFileDetails($client_id,$assessment_type=1,$teacher_student=array(),$round="",$gaid=0){$evidence_condition=" (fs.evidence_text !=''  || f.file_id IS NOT NULL) ";$evidence_condition=" 1=1 ";if($assessment_type==2 || $assessment_type==4){ $onlyActive=" && dga.isGroupAssessmentActive=1"; $groupBy=" group by a.assessment_id,c.client_id,e.judgement_statement_text,hu.user_id,dga.student_round "; //$orderBy=" order by c.client_id,k.kpa_id,l.key_question_id,m.core_question_id,e.judgement_statement_id,hu.user_id,dga.student_round ";  $orderBy=" order by c.client_id,j.kpa_order ,i.kq_order,h.cq_order,d.js_order,hu.user_id,dga.student_round,a.assessment_id "; $onCondidtion=" a.assessment_id=b.assessment_id and a.judgement_statement_instance_id=b.judgement_statement_instance_id and a.judgement_statement_id = b.judgement_statement_id and a.client_id=b.client_id && a.student_round=b.student_round "; //$final_order=" order by client_id,judgement_statement_id,name,student_round"; $final_order=" order by client_id,student_round,name,assessment_id,diagnostic_id,kpa_order,kq_order,cq_order,js_order "; if(count($teacher_student)>0){ $teacher_student_condiditon=" && hu.user_id IN (".(implode(",",$teacher_student)).") "; $teacher_student_condiditon_internal=" && hu_internal.user_id IN (".(implode(",",$teacher_student)).") "; }else{ $teacher_student_condiditon="";    $teacher_student_condiditon_internal="";  }  if($round!=""){    $round_condiditon =" && dga.student_round='".$round."'"; }else{    $round_condiditon ="";  }  if($gaid>0){     $gaid_condition=" && dga.group_assessment_id='".$gaid."'"; }else{     $gaid_condition=""; } }else{ $onlyActive=" && a.isAssessmentActive=1"; $groupBy=" group by a.assessment_id,c.client_id,e.judgement_statement_text,a.aqs_round"; //$orderBy=" order by c.client_id,k.kpa_id,l.key_question_id,m.core_question_id,e.judgement_statement_id,a.aqs_round "; $orderBy=" order by c.client_id,j.kpa_order ,i.kq_order,h.cq_order,d.js_order,a.aqs_round,a.assessment_id "; $onCondidtion=" a.assessment_id=b.assessment_id and a.judgement_statement_instance_id=b.judgement_statement_instance_id and a.judgement_statement_id = b.judgement_statement_id and a.client_id=b.client_id && a.aqs_round=b.aqs_round "; //$final_order=" order by client_id,judgement_statement_id,aqs_round"; $final_order=" order by client_id,aqs_round,assessment_id,diagnostic_id,kpa_order,kq_order,cq_order,js_order"; $teacher_student_condiditon=""; $teacher_student_condiditon_internal="";  if($round!=""){    $round_condiditon =" && a.aqs_round='".$round."'"; }else{    $round_condiditon ="";  }  if($gaid>0){     $gaid_condition=" && dga.group_assessment_id='".$gaid."'"; }else{     $gaid_condition=""; } }$assessmentCond = 'b.assessment_type_id=?';if(!empty($assessment_type) && $assessment_type == 'self'){    $assessment_type = 1;    $assessmentCond .= ' AND a.d_sub_assessment_type_id = 1';    $round_condiditon="";}$sql="select * from (select a.aqs_round,a.student_round,a.name,a.user_id,a.judgement_statement_id,a.judgement_statement_instance_id,a.client_id,a.client_name,a.js_order,a.cq_order,a.kq_order,a.kpa_order,a.kpa_id,a.kpa_name,a.key_question_text,a.core_question_text,a.judgement_statement_text,a.internal_evidence,b.external_evidence,ifnull(a.file_int,'') as file_int,ifnull(b.file_ext,'') as file_ext,a.network_name, a.province_name,a.diagnostic_id,a.assessment_id  from(select  a.aqs_round,dga.student_round,du.name,du.user_id,e.judgement_statement_id,fs.judgement_statement_instance_id,c.client_id,c.client_name,d.js_order,h.cq_order,i.kq_order,j.kpa_order,k.kpa_id,k.kpa_name,l.key_question_text,m.core_question_text,e.judgement_statement_text,fs.evidence_text as internal_evidence,group_concat(distinct g.file_name  SEPARATOR '#T@t@#') as file_int, dn.network_name, dp.province_name,a.assessment_id,a.diagnostic_idfrom f_score fsinner join h_assessment_user hu on fs.assessment_id=hu.assessment_id and fs.assessor_id=hu.user_id and hu.role=3inner join d_assessment a on a.assessment_id=fs.assessment_idinner join d_diagnostic b on a.diagnostic_id=b.diagnostic_idinner join d_client c on a.client_id=c.client_idinner join h_cq_js_instance d on fs.judgement_statement_instance_id=d.judgement_statement_instance_idinner join (select djs.*,hlt.translation_text as judgement_statement_text from d_judgement_statement djs inner join h_lang_translation hlt on djs.equivalence_id=hlt.equivalence_id where language_id=9) e on d.judgement_statement_id= e.judgement_statement_idleft join h_score_file f on fs.score_id=f.score_idleft join d_file g on f.file_id=g.file_idleft join h_kq_cq h on d.core_question_instance_id=h.core_question_instance_idleft join h_kpa_kq i on h.key_question_instance_id=i.key_question_instance_idleft join h_kpa_diagnostic j on i.kpa_instance_id=j.kpa_instance_idleft join (select dkpa.*,hlt.translation_text as kpa_name from d_kpa dkpa inner join h_lang_translation hlt on dkpa.equivalence_id=hlt.equivalence_id where language_id=9) k on j.kpa_id=k.kpa_idleft join (select dkq.*,hlt.translation_text as key_question_text from d_key_question dkq inner join h_lang_translation hlt on dkq.equivalence_id=hlt.equivalence_id where language_id=9) l on i.key_question_id=l.key_question_idleft join (select dcq.*,hlt.translation_text as core_question_text from d_core_question dcq inner join h_lang_translation hlt on dcq.equivalence_id=hlt.equivalence_id where language_id=9) m on h.core_question_id=m.core_question_idleft join h_client_province hcp on hcp.client_id=c.client_idleft join d_province dp on dp.province_id=hcp.province_idleft join h_client_network hcn on c.client_id=hcn.client_idleft join d_network dn on dn.network_id=hcn.network_idleft join h_assessment_ass_group haag on haag.assessment_id=a.assessment_idleft join d_group_assessment dga on dga.group_assessment_id=haag.group_assessment_idleft join d_user du on du.user_id=hu.user_idwhere  $evidence_condition and $assessmentCond and c.client_id=? and fs.isFinal=1 ".$onlyActive." ".$teacher_student_condiditon." ".$round_condiditon." ".$gaid_condition."".$groupBy." ".$orderBy." ) aleft join (select  a.aqs_round,dga.student_round,du.name,du.user_id,e.judgement_statement_id,fs.judgement_statement_instance_id,c.client_id,c.client_name,d.js_order,h.cq_order,i.kq_order,j.kpa_order,k.kpa_id,k.kpa_name,l.key_question_text,m.core_question_text,e.judgement_statement_text,fs.evidence_text as external_evidence,group_concat(distinct g.file_name  SEPARATOR '#T@t@#') as file_ext,a.assessment_idfrom f_score fsinner join h_assessment_user hu on fs.assessment_id=hu.assessment_id and fs.assessor_id=hu.user_id and hu.role=4inner join d_assessment a on a.assessment_id=fs.assessment_idinner join d_diagnostic b on a.diagnostic_id=b.diagnostic_idinner join d_client c on a.client_id=c.client_idinner join h_cq_js_instance d on fs.judgement_statement_instance_id=d.judgement_statement_instance_idinner join (select djs.*,hlt.translation_text as judgement_statement_text from d_judgement_statement djs  inner join h_lang_translation hlt on djs.equivalence_id=hlt.equivalence_id where language_id=9) e on d.judgement_statement_id= e.judgement_statement_idleft join h_score_file f on fs.score_id=f.score_idleft join d_file g on f.file_id=g.file_idleft join h_kq_cq h on d.core_question_instance_id=h.core_question_instance_idleft join h_kpa_kq i on h.key_question_instance_id=i.key_question_instance_idleft join h_kpa_diagnostic j on i.kpa_instance_id=j.kpa_instance_idleft join (select dkpa.*,hlt.translation_text as kpa_name from d_kpa dkpa inner join h_lang_translation hlt on dkpa.equivalence_id=hlt.equivalence_id where language_id=9) k on j.kpa_id=k.kpa_idleft join (select dkq.*,hlt.translation_text as key_question_text from d_key_question dkq inner join h_lang_translation hlt on dkq.equivalence_id=hlt.equivalence_id where language_id=9) l on i.key_question_id=l.key_question_idleft join (select dcq.*,hlt.translation_text as core_question_text from d_core_question dcq inner join h_lang_translation hlt on dcq.equivalence_id=hlt.equivalence_id where language_id=9) m on h.core_question_id=m.core_question_idleft join h_assessment_ass_group haag on haag.assessment_id=a.assessment_idleft join d_group_assessment dga on dga.group_assessment_id=haag.group_assessment_idleft join d_user du on du.user_id=hu.user_idwhere  $evidence_condition and $assessmentCond and c.client_id=?  and fs.isFinal=1  ".$onlyActive."  ".$round_condiditon."  ".$gaid_condition."".$groupBy." ".$orderBy.")bon ".$onCondidtion."UNIONselect b.aqs_round,b.student_round,b.name,b.user_id,b.judgement_statement_id,b.judgement_statement_instance_id,b.client_id,b.client_name,b.js_order,b.cq_order,b.kq_order,b.kpa_order,b.kpa_id,b.kpa_name,b.key_question_text,b.core_question_text,b.judgement_statement_text,a.internal_evidence,b.external_evidence,ifnull(a.file_int,'') as file_int,ifnull(b.file_ext,'') as file_ext,b.network_name, b.province_name,b.diagnostic_id,a.assessment_id   from(select  a.aqs_round,dga.student_round,du.name,du.user_id,e.judgement_statement_id,fs.judgement_statement_instance_id,c.client_id,c.client_name,d.js_order,h.cq_order,i.kq_order,j.kpa_order,k.kpa_id,k.kpa_name,l.key_question_text,m.core_question_text,e.judgement_statement_text,fs.evidence_text as internal_evidence,group_concat(distinct g.file_name   SEPARATOR '#T@t@#') as file_int,a.assessment_idfrom f_score fsinner join h_assessment_user hu on fs.assessment_id=hu.assessment_id and fs.assessor_id=hu.user_id and hu.role=3inner join d_assessment a on a.assessment_id=fs.assessment_idinner join d_diagnostic b on a.diagnostic_id=b.diagnostic_idinner join d_client c on a.client_id=c.client_idinner join h_cq_js_instance d on fs.judgement_statement_instance_id=d.judgement_statement_instance_idinner join (select djs.*,hlt.translation_text as judgement_statement_text from d_judgement_statement djs inner join h_lang_translation hlt on djs.equivalence_id=hlt.equivalence_id where language_id=9) e on d.judgement_statement_id= e.judgement_statement_idleft join h_score_file f on fs.score_id=f.score_idleft join d_file g on f.file_id=g.file_idleft join h_kq_cq h on d.core_question_instance_id=h.core_question_instance_idleft join h_kpa_kq i on h.key_question_instance_id=i.key_question_instance_idleft join h_kpa_diagnostic j on i.kpa_instance_id=j.kpa_instance_idleft join (select dkpa.*,hlt.translation_text as kpa_name from d_kpa dkpa inner join h_lang_translation hlt on dkpa.equivalence_id=hlt.equivalence_id where language_id=9) k on j.kpa_id=k.kpa_idleft join (select dkq.*,hlt.translation_text as key_question_text from d_key_question dkq inner join h_lang_translation hlt on dkq.equivalence_id=hlt.equivalence_id where language_id=9) l on i.key_question_id=l.key_question_idleft join (select dcq.*,hlt.translation_text as core_question_text from d_core_question dcq inner join h_lang_translation hlt on dcq.equivalence_id=hlt.equivalence_id where language_id=9) m on h.core_question_id=m.core_question_idleft join h_assessment_ass_group haag on haag.assessment_id=a.assessment_idleft join d_group_assessment dga on dga.group_assessment_id=haag.group_assessment_idleft join d_user du on du.user_id=hu.user_idwhere $evidence_condition and $assessmentCond  and c.client_id=?  and fs.isFinal=1 ".$onlyActive." ".$teacher_student_condiditon."  ".$round_condiditon."  ".$gaid_condition."".$groupBy." ".$orderBy." ) aright join (select  a.aqs_round,dga.student_round,du_internal.name,du_internal.user_id,e.judgement_statement_id,fs.judgement_statement_instance_id,c.client_id,c.client_name,d.js_order,h.cq_order,i.kq_order,j.kpa_order,k.kpa_id,k.kpa_name,l.key_question_text,m.core_question_text,e.judgement_statement_text,fs.evidence_text as external_evidence,group_concat(distinct g.file_name   SEPARATOR '#T@t@#') as file_ext, dn.network_name, dp.province_name,a.assessment_id,a.diagnostic_idfrom f_score fsinner join h_assessment_user hu on fs.assessment_id=hu.assessment_id and fs.assessor_id=hu.user_id and hu.role=4inner join d_assessment a on a.assessment_id=fs.assessment_idinner join d_diagnostic b on a.diagnostic_id=b.diagnostic_idinner join d_client c on a.client_id=c.client_idinner join h_cq_js_instance d on fs.judgement_statement_instance_id=d.judgement_statement_instance_idinner join (select djs.*,hlt.translation_text as judgement_statement_text from d_judgement_statement djs inner join h_lang_translation hlt on djs.equivalence_id=hlt.equivalence_id where language_id=9) e on d.judgement_statement_id= e.judgement_statement_idleft join h_score_file f on fs.score_id=f.score_idleft join d_file g on f.file_id=g.file_idleft join h_kq_cq h on d.core_question_instance_id=h.core_question_instance_idleft join h_kpa_kq i on h.key_question_instance_id=i.key_question_instance_idleft join h_kpa_diagnostic j on i.kpa_instance_id=j.kpa_instance_idleft join (select dkpa.*,hlt.translation_text as kpa_name from d_kpa dkpa inner join h_lang_translation hlt on dkpa.equivalence_id=hlt.equivalence_id where language_id=9) k on j.kpa_id=k.kpa_idleft join (select dkq.*,hlt.translation_text as key_question_text from d_key_question dkq inner join h_lang_translation hlt on dkq.equivalence_id=hlt.equivalence_id where language_id=9) l on i.key_question_id=l.key_question_idleft join (select dcq.*,hlt.translation_text as core_question_text from d_core_question dcq inner join h_lang_translation hlt on dcq.equivalence_id=hlt.equivalence_id where language_id=9) m on h.core_question_id=m.core_question_idleft join h_client_province hcp on hcp.client_id=c.client_idleft join d_province dp on dp.province_id=hcp.province_idleft join h_client_network hcn on c.client_id=hcn.client_idleft join d_network dn on dn.network_id=hcn.network_idleft join h_assessment_ass_group haag on haag.assessment_id=a.assessment_idleft join d_group_assessment dga on dga.group_assessment_id=haag.group_assessment_idleft join d_user du on du.user_id=hu.user_idleft join h_assessment_user hu_internal on a.assessment_id=hu_internal.assessment_id and hu_internal.role=3left join d_user du_internal on du_internal.user_id=hu_internal.user_idwhere  $evidence_condition and $assessmentCond  and c.client_id=?  and fs.isFinal=1  ".$onlyActive." ".$teacher_student_condiditon_internal."  ".$round_condiditon."  ".$gaid_condition."".$groupBy." ".$orderBy.")bon ".$onCondidtion.") final_table ".$final_order."";               // $this->db->regenerateQuery($sql,array($assessment_type,$client_id,$assessment_type,$client_id,$assessment_type,$client_id,$assessment_type,$client_id));              // die("jjjj");                $res= $this->db->get_results($sql,array($assessment_type,$client_id,$assessment_type,$client_id,$assessment_type,$client_id,$assessment_type,$client_id));		if($res)                        {			return $res;		}else                {			return array();                	}     }        public function getDistinctClient(){$sql="SELECT  group_concat(distinct c.client_id) as client_id,count(distinct c.client_id) as client_count,group_concat(distinct c.client_name separator ';') as client_namefrom f_score fsinner join d_assessment a on fs.assessment_id=a.assessment_idinner join d_diagnostic b on a.diagnostic_id=b.diagnostic_idinner join d_client c on a.client_id=c.client_idinner join h_cq_js_instance d on fs.judgement_statement_instance_id=d.judgement_statement_instance_idinner join (select djs.*,hlt.translation_text as judgement_statement_text from d_judgement_statement djs inner join h_lang_translation hlt on djs.equivalence_id=hlt.equivalence_id where language_id=9) e on d.judgement_statement_id= e.judgement_statement_idinner join h_score_file f on fs.score_id=f.score_idwhere fs.evidence_text!='' and client_name not in ('Algorithmic Insight School','aischool','xyz','Sarabjit','Adhschool')";$res= $this->db->get_row($sql);		if($res)                        {			return $res;		}else                {			return array();                	}     }     public function getDistinctClientSearch($school_related_to,$network,$province,$school,$assessment_type=1,$teacher_student=array(),$gaid=0,$round=""){$school_count=count($school);$province_count=count($province);$network_count=count($network);$assessmentCond = 'b.assessment_type_id=?';$queryParams = array();if(!empty($assessment_type) && $assessment_type == 'self'){        $assessmentCond .= ' AND a.d_sub_assessment_type_id = ?';    $queryParams[] = 1;    $queryParams[] = 1;    }else {    $queryParams[] = $assessment_type; }$sql_group_limit="SET SESSION group_concat_max_len = 1000000;";$this->db->query($sql_group_limit);$sql="SELECT  group_concat(distinct c.client_id) as client_id,count(distinct c.client_id) as client_count,group_concat(distinct c.client_name separator ';') as client_namefrom f_score fsinner join d_assessment a on fs.assessment_id=a.assessment_idinner join d_diagnostic b on a.diagnostic_id=b.diagnostic_idinner join d_client c on a.client_id=c.client_idinner join h_cq_js_instance d on fs.judgement_statement_instance_id=d.judgement_statement_instance_idinner join (select djs.*,hlt.translation_text as judgement_statement_text from d_judgement_statement djs inner join h_lang_translation hlt on djs.equivalence_id=hlt.equivalence_id where language_id=9) e on d.judgement_statement_id= e.judgement_statement_idleft join h_assessment_ass_group haag on haag.assessment_id=a.assessment_idleft join d_group_assessment dga on dga.group_assessment_id=haag.group_assessment_idleft join h_score_file f on fs.score_id=f.score_id ";if($school_related_to=="1" && $school_count==0){if($province_count>0){    $sql.="left join h_client_province hcp on hcp.client_id=c.client_id ";$sql.="left join h_province_network hpn on hcp.province_id=hpn.province_id ";}else{$sql.="left join h_client_network hcn on c.client_id=hcn.client_id ";}}else if($school_related_to=="2"  && $school_count==0){$sql.="left join h_client_network hcn on c.client_id=hcn.client_id ";    }if(($assessment_type=="2" || $assessment_type=="4") && count($teacher_student)>0){       $sql.="left join h_assessment_user hau on a.assessment_id=hau.assessment_id && role=3";     }$sql.=" where (fs.evidence_text!='' || f.file_id IS NOT NULL) and $assessmentCond and client_name not in ('Algorithmic Insight School','aischool','xyz','Sarabjit','Adhschool') ";if($school_related_to=="2"  && $school_count==0){$sql.=" && hcn.network_id IS NULL ";    }if($school_related_to=="1" && $school_count==0){if($province_count>0){if($province_count>0){$sql.=" && hcp.province_id IN (".(implode(",",$province)).") ";}        if($network_count>0){$sql.=" && hpn.network_id IN (".(implode(",",$network)).") ";}}else{if($network_count>0){$sql.=" && hcn.network_id IN (".(implode(",",$network)).") ";}}} if($school_count>0){$sql.=" && c.client_id IN (".(implode(",",$school)).") ";    }if(($assessment_type=="2" || $assessment_type=="4") && count($teacher_student)>0){    $sql.=" && hau.user_id IN (".(implode(",",$teacher_student)).") ";}if($gaid>0){        $sql.=" && dga.group_assessment_id = '".$gaid."'";}if($assessment_type=="2" || $assessment_type=="4"){    if($round!=""){    $sql .=" && dga.student_round='".$round."'"; } }else{      if($round!=""){    $sql .=" && a.aqs_round='".$round."'"; }  }//echo $sql;$res= $this->db->get_row($sql,$queryParams);		if($res)                        {			return $res;		}else                {			return array();                	}     }               function getSummaryData($network,$fromDate="",$toDate=""){         $val_array=array();         $val_array[]=$network;         $sql="SELECT h.network_name,f.province_name,d.client_name,sum(if(dga.student_round=1,1,0)) as Round1_Total,sum(if((b.percComplete=100 && b.isFilled=1 && c.percComplete=100 && c.isFilled=1 && dga.student_round=1),1,0)) as Round1_completed , (sum(if(dga.student_round=1,1,0))-sum(if((b.percComplete=100 && b.isFilled=1 && c.percComplete=100 && c.isFilled=1 && dga.student_round=1),1,0))) as Round1_incompleted , sum(if(dga.student_round=2,1,0)) as Round2_Total,sum(if((b.percComplete=100 && b.isFilled=1 && c.percComplete=100 && c.isFilled=1 && dga.student_round=2),1,0)) as Round2_completed , (sum(if(dga.student_round=2,1,0))-sum(if((b.percComplete=100 && b.isFilled=1 && c.percComplete=100 && c.isFilled=1 && dga.student_round=2),1,0))) as Round2_incompleted FROM (select * from d_group_assessment where assessment_type_id=4) dga inner join h_assessment_ass_group haag on dga.group_assessment_id=haag.group_assessment_idinner join d_assessment a on haag.assessment_id=a.assessment_idleft join h_assessment_user b on a.assessment_id=b.assessment_id && b.role=3left join h_assessment_user c on a.assessment_id=c.assessment_id && c.role=4left join d_client d on d.client_id=a.client_idleft join h_client_province e on d.client_id=e.client_idleft join d_province f on e.province_id=f.province_idleft join h_province_network g on g.province_id=f.province_idleft join d_network h on  h.network_id=g.network_id where h.network_id=? ";                  if($fromDate!="" && $toDate!=""){          $sql.=" && DATE(dga.creation_date) BETWEEN ? AND ? ";          $val_array[]=$fromDate;          $val_array[]=$toDate;         }                                 $sql.=" group by f.province_id,d.client_id order by f.province_id,d.client_id;";                $res= $this->db->get_results($sql,$val_array);       return $res=($res)?$res:array();            }     function getExcelData(){                 $sql="SELECT h.network_name,f.province_name,d.client_name,GROUP_CONCAT( DISTINCT dga.group_assessment_id order by dga.group_assessment_id asc) as gids,sum(if(dga.student_round=1,1,0)) as Round1_Total,sum(if((b.percComplete=100 && b.isFilled=1 && c.percComplete=100 && c.isFilled=1 && dga.student_round=1),1,0)) as Round1_completed , (sum(if(dga.student_round=1,1,0))-sum(if((b.percComplete=100 && b.isFilled=1 && c.percComplete=100 && c.isFilled=1 && dga.student_round=1),1,0))) as Round1_incompleted , sum(if(dga.student_round=2,1,0)) as Round2_Total,sum(if((b.percComplete=100 && b.isFilled=1 && c.percComplete=100 && c.isFilled=1 && dga.student_round=2),1,0)) as Round2_completed , (sum(if(dga.student_round=2,1,0))-sum(if((b.percComplete=100 && b.isFilled=1 && c.percComplete=100 && c.isFilled=1 && dga.student_round=2),1,0))) as Round2_incompleted FROM (select * from d_group_assessment where assessment_type_id=4) dga inner join h_assessment_ass_group haag on dga.group_assessment_id=haag.group_assessment_idinner join d_assessment a on haag.assessment_id=a.assessment_idleft join h_assessment_user b on a.assessment_id=b.assessment_id && b.role=3left join h_assessment_user c on a.assessment_id=c.assessment_id && c.role=4left join d_client d on d.client_id=a.client_idleft join h_client_province e on d.client_id=e.client_idleft join d_province f on e.province_id=f.province_idleft join h_province_network g on g.province_id=f.province_idleft join d_network h on  h.network_id=g.network_id where h.network_id=55 group by f.province_id,d.client_id order by f.province_id,d.client_id;";                $res= $this->db->get_results($sql);       return $res=($res)?$res:array();              }          function getSummaryStudentData ($network,$fromDate="",$toDate=""){         $val_array=array();         $val_array[]=$network;                  $sql="select xyz.network_name,xyz.province_name,xyz.client_name,xyz.student_name,sum(Round_1_status) as r1_status,sum(Round_2_status) as r2_status from (SELECT h.network_name,f.province_name,d.client_name,du.name as student_name,b.user_id,dga.student_round,if((b.percComplete=100 && b.isFilled=1 && c.percComplete=100 && c.isFilled=1 && dga.student_round=1),1,0) as Round_1_status,if((b.percComplete=100 && b.isFilled=1 && c.percComplete=100 && c.isFilled=1 && dga.student_round=2),1,0) as Round_2_statusFROM (select * from d_group_assessment where assessment_type_id=4) dga inner join h_assessment_ass_group haag on dga.group_assessment_id=haag.group_assessment_idinner join d_assessment a on haag.assessment_id=a.assessment_idleft join h_assessment_user b on a.assessment_id=b.assessment_id && b.role=3left join h_assessment_user c on a.assessment_id=c.assessment_id && c.role=4left join d_user du on b.user_id=du.user_idleft join d_client d on d.client_id=a.client_idleft join h_client_province e on d.client_id=e.client_idleft join d_province f on e.province_id=f.province_idleft join h_province_network g on g.province_id=f.province_idleft join d_network h on  h.network_id=g.network_id where h.network_id=? " ;                  if($fromDate!="" && $toDate!=""){          $sql.=" && DATE(dga.creation_date) BETWEEN ? AND ? ";          $val_array[]=$fromDate;          $val_array[]=$toDate;         }                        $sql.=") xyz group by user_id order by xyz.network_name,xyz.province_name,xyz.client_name,xyz.student_name desc";                        $res= $this->db->get_results($sql,$val_array);       return $res=($res)?$res:array();           }       function round2Id($groupid,$round1_assesment_id){            //$query="select user_id from h_assessment_user where assessment_id=? && role=3";            $query1="select b.* from d_assessment a inner join h_assessment_user b on a.assessment_id=b.assessment_id inner join h_assessment_ass_group c on a.assessment_id=c.assessment_id inner join d_group_assessment d on c.group_assessment_id=d.group_assessment_id where b.role=3 && b.user_id=(select user_id from h_assessment_user where assessment_id=$round1_assesment_id && role=3) && d.student_round=2  ";      $res= $this->db->get_row($query1);      return $res=($res)?$res:array();        }  }